#!/bin/sh

. /lib/functions/network.sh

INTF=phantap
network_get_device BRIDGE $INTF
[ -z "$BRIDGE" ] && { echo "Bridge not ready"; exit; }

echo "Listening to traffic ..."

tcpdump -i $BRIDGE -lt -vvv -nn -e -Q in -q 'arp [6:2] = 1' | sed -E 's/^([0-9a-f:]{17}).*tell (\d+\.\d+\.\d+\.\d+).*/mysedworked \1 \2/' | while read RES MAC IP; do
    # uses tcpdump to grab IPV4 arp traffic
    # arp [6:2] = 1 only tell packets

    if [ "$RES" != "mysedworked" ]; then
        echo "Unable to parse captured packet, continuing"
        sleep 1
    fi
    if [ "$IP" != 0.0.0.0 ]; then
        ip neigh replace $IP lladdr $MAC dev $BRIDGE
        ip route replace $IP dev $BRIDGE
        echo "Adding neighbour! MAC=$MAC, IP=$IP"
    fi
done
